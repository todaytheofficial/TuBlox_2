<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TuBlox 2 - Dashboard</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        /* Дополнительные стили для вкладок, чтобы вписались в твой CSS */
        .nav-tabs { display: flex; gap: 20px; margin: 20px 5%; border-bottom: 2px solid #2d3436; padding-bottom: 10px; }
        .tab-btn { background: none; border: none; color: var(--text-muted); font-size: 18px; font-weight: bold; cursor: pointer; font-family: var(--font-head); }
        .tab-btn.active { color: var(--primary); border-bottom: 3px solid var(--primary); padding-bottom: 7px; }

        .section { display: none; }
        .section.active { display: block; }

        .create-panel { 
            background: var(--card-bg); padding: 20px; border-radius: var(--radius-m); 
            margin: 20px 5%; border: 3px solid #2d3436; display: flex; gap: 15px; align-items: center;
        }
        .create-panel input { 
            flex: 1; padding: 12px; border-radius: var(--radius-s); border: 2px solid transparent; 
            background: var(--input-bg); color: white; outline: none; transition: 0.2s;
        }
        .create-panel input:focus { border-color: var(--primary); }
    </style>
</head>
<body>
    <header>
        <div class="logo">TuBlox</div>
        <div class="header-right">
            <button onclick="location.href='shop.html'" class="btn-icon" title="Shop">
                <svg viewBox="0 0 24 24"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 0 1-8 0"/></svg>
            </button>
            <div id="profile-area">
                <a href="login.html" class="btn-primary" style="padding: 8px 16px; font-size: 14px; width: auto;">Log In</a>
            </div>
        </div>
    </header>

    <nav class="nav-tabs">
        <button class="tab-btn active" onclick="switchTab('discover', event)">Discover</button>
        <button class="tab-btn" onclick="switchTab('studio', event)">Studio</button>
    </nav>

    <main>
        <div id="discover" class="section active">
            <h2 style="margin: 20px;">Popular Games</h2>
            <div id="games-list" class="grid">Loading games...</div>
        </div>

        <div id="studio" class="section">
            <div class="create-panel">
                <input type="text" id="new-game-name" placeholder="Name your new game...">
                <button class="btn-primary" onclick="createNewGame()" style="width: auto;">+ Create</button>
            </div>
            <h2 style="margin: 20px;">My Creations</h2>
            <div id="my-games-list" class="grid">You haven't created any games yet.</div>
        </div>
    </main>

    <div id="game-modal" class="modal-overlay">
        <div class="modal-box">
            <h2 id="gm-name">Game Name</h2>
            <p id="gm-author" style="color:var(--text-muted)">Author</p>
            <div id="gm-stats" style="margin: 15px 0; font-size:14px; color:var(--accent);">Stats</div>
            <p id="gm-desc" style="color:var(--text-main); font-size:14px; margin-bottom:20px;">Description...</p>
            <div class="modal-actions">
                <button id="btn-play" class="btn-primary" style="flex:2;">▶ PLAY</button>
                <button onclick="closeGameModal()" class="btn-shop" style="width:50px; margin:0;">×</button>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/utils.js"></script>
    <script>
        const socket = io();
        let user = null;

        async function init() {
            user = await getSession();
            if(user) {
                const avatarSvg = getAvatarSVG(user);
                document.getElementById('profile-area').innerHTML = `
                    <div style="display:flex; align-items:center; gap:10px;">
                        <div class="vubs-badge" onclick="location.href='shop.html'" style="cursor:pointer">
                            <img src="assets/vubs.png" class="vubs-icon-img">
                            <span class="vubs-amount">${user.balance}</span>
                        </div>
                        <div class="profile-pill" onclick="location.href='profile.html'">
                            <div class="mini-avatar-svg">${avatarSvg}</div>
                            <span>${user.username}</span>
                        </div>
                    </div>
                `;
            }
            socket.emit('request_games');
        }

        function switchTab(tabId, event) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            event.currentTarget.classList.add('active');
        }

        socket.on('update_dashboard', games => {
            const list = document.getElementById('games-list');
            const myList = document.getElementById('my-games-list');
            list.innerHTML = '';
            myList.innerHTML = '';

            games.forEach(g => {
                const cardHtml = `
                    <div class="card-img-placeholder"></div>
                    <div class="card-content">
                        <h4>${g.name}</h4>
                        <div class="card-meta">
                            <span>Online: ${g.online || 0}</span>
                            <span>Visits: ${g.visits || 0}</span>
                        </div>
                    </div>
                `;

                // Для вкладки Discover
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = cardHtml;
                card.onclick = () => openGameModal(g);
                list.appendChild(card);

                // Для вкладки Studio
                if (user && g.author === user.username) {
                    const myCard = document.createElement('div');
                    myCard.className = 'card';
                    myCard.innerHTML = cardHtml + `<div style="padding: 0 20px 20px;"><button class="btn-shop" onclick="event.stopPropagation(); location.href='studio.html?id=${g.id}'">EDIT STUDIO</button></div>`;
                    myList.appendChild(myCard);
                }
            });
        });

        async function createNewGame() {
            const name = document.getElementById('new-game-name').value;
            if(!name || !user) return alert("Login and enter name!");
            
            const gameId = 'g_' + Math.random().toString(36).substr(2, 9);
            try {
                const res = await fetch('/api/save_game_data', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ gameId, username: user.username, name, map: [] })
                });
                const result = await res.json();
                if(result.success) location.reload();
                else alert(result.error);
            } catch(e) {
                alert("Server error. Make sure node server.js is running!");
            }
        }

        function openGameModal(game) {
            document.getElementById('gm-name').textContent = game.name;
            document.getElementById('gm-author').textContent = "By " + game.author;
            document.getElementById('gm-stats').innerHTML = `Online: ${game.online || 0} | Visits: ${game.visits || 0}`;
            document.getElementById('btn-play').onclick = () => location.href = `game.html?id=${game.id}`;
            document.getElementById('game-modal').style.display = 'flex';
        }

        function closeGameModal() { document.getElementById('game-modal').style.display = 'none'; }
        
        init();
    </script>
</body>
</html>