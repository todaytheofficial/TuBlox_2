<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TuBlox 2 - Dashboard</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <header>
        <!-- 1. –õ–æ–≥–æ—Ç–∏–ø -->
        <div class="logo">TuBlox</div>

        <!-- 2. –ü–æ–∏—Å–∫ –ø–æ —Ü–µ–Ω—Ç—Ä—É -->
        <div class="search-wrapper">
            <input type="text" id="game-search" class="search-input" placeholder="Search games...">
            <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="11" cy="11" r="8"></circle>
                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
            </svg>
        </div>

        <!-- 3. –ü—Ä–∞–≤–∞—è —á–∞—Å—Ç—å (–ü—Ä–æ—Ñ–∏–ª—å + –ö–Ω–æ–ø–∫–∏) -->
        <div class="header-right">
            <button onclick="startNewGame()" class="btn-primary" style="background: var(--success); padding: 8px 16px; font-size: 14px;">
                + Create
            </button>
            
            <button onclick="location.href='shop.html'" class="btn-icon" title="Shop">
                <svg viewBox="0 0 24 24"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 0 1-8 0"/></svg>
            </button>
            
            <div id="profile-area">
                <a href="login.html" class="btn-primary" style="width: auto;">Log In</a>
            </div>
        </div>
    </header>

    <nav class="nav-tabs">
        <button class="tab-btn active" onclick="switchTab('discover', event)">Discover</button>
        <button class="tab-btn" onclick="switchTab('studio', event)">My Studio</button>
    </nav>

    <main>
        <!-- –í–∫–ª–∞–¥–∫–∞ DISCOVER -->
        <div id="discover" class="section active">
            <div class="section-header">
                <div style="display:flex; align-items:center;">
                    <h2 id="discover-title">Popular Games</h2>
                    <span id="search-status" class="search-status-text"></span>
                </div>
            </div>
            <div id="games-list" class="grid">
                <p style="color:#666; margin-left: 10px;">Loading...</p>
            </div>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞ STUDIO -->
        <div id="studio" class="section">
            <div class="section-header">
                <h2>My Creations</h2>
                <button onclick="startNewGame()" class="btn-primary" style="width: auto; font-size: 14px;">+ New Project</button>
            </div>
            
            <div id="my-games-list" class="grid">
                <p style="color: #888;">You haven't published any games yet.</p>
            </div>
        </div>
    </main>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ PLAY -->
    <div id="game-modal" class="modal-overlay">
        <div class="modal-box">
            <button onclick="closeGameModal()" class="close-btn">√ó</button>
            <h2 id="gm-name" style="color: var(--primary);">Game Name</h2>
            <p id="gm-author" style="color:var(--text-muted); font-size: 18px;">Author</p>
            
            <div style="background: #20202a; padding: 15px; border-radius: 12px; margin: 20px 0; display:flex; justify-content: space-around;">
                <span id="gm-online" style="color: var(--success); font-weight: bold;">Online: 0</span>
                <span id="gm-visits" style="color: var(--accent); font-weight: bold;">Visits: 0</span>
            </div>

            <p id="gm-desc" style="color:#ccc; font-size:14px; margin-bottom:25px;">No description provided.</p>
            
            <div class="modal-actions">
                <button id="btn-play" class="btn-primary" style="width: 100%; font-size: 20px; padding: 15px;">‚ñ∂ PLAY NOW</button>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/utils.js"></script>
    <script>
        const socket = io();
        let user = null;
        let allGamesCache = []; // –•—Ä–∞–Ω–∏–º –≤—Å–µ –∏–≥—Ä—ã –ª–æ–∫–∞–ª—å–Ω–æ –¥–ª—è –ø–æ–∏—Å–∫–∞

        async function init() {
            user = await getSession();
            if(user) {
                const avatarSvg = getAvatarSVG(user);
                document.getElementById('profile-area').innerHTML = `
                    <div style="display:flex; align-items:center; gap:15px;">
                        <div class="vubs-badge" onclick="location.href='shop.html'">
                            <img src="assets/vubs.png" class="vubs-icon-img">
                            <span class="vubs-amount">${user.balance}</span>
                        </div>
                        <div class="profile-pill" onclick="location.href='profile.html'">
                            <div class="mini-avatar-svg">${avatarSvg}</div>
                            <span>${user.username}</span>
                        </div>
                    </div>
                `;
                
                if (user.is_admin) {
                    const btn = document.createElement('button');
                    btn.className = 'btn-icon';
                    btn.style.color = '#ff7675';
                    btn.innerHTML = '‚öô';
                    btn.title = "Admin Panel";
                    btn.onclick = () => location.href = 'admin.html';
                    document.querySelector('.header-right').prepend(btn);
                }
            }
            socket.emit('request_games');
        }

        function switchTab(tabId, event) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            event.currentTarget.classList.add('active');
        }

        function startNewGame() {
            if(!user) return alert("Please log in to create games!");
            const tempId = 'g_' + Math.random().toString(36).substr(2, 9);
            window.location.href = `studio.html?id=${tempId}`;
        }

        // --- –õ–û–ì–ò–ö–ê –ü–û–ò–°–ö–ê ---
        const searchInput = document.getElementById('game-search');
        const searchStatus = document.getElementById('search-status');
        const discoverTitle = document.getElementById('discover-title');

        searchInput.addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase().trim();
            
            // –ï—Å–ª–∏ –º—ã –Ω–µ –Ω–∞ –≤–∫–ª–∞–¥–∫–µ Discover, –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º –Ω–∞ –Ω–µ—ë
            if(!document.getElementById('discover').classList.contains('active')) {
                document.querySelector('.tab-btn[onclick*="discover"]').click();
            }

            if(query.length > 0) {
                discoverTitle.style.display = 'none';
                searchStatus.innerHTML = `üîé Searching for: "<span style="color:white">${e.target.value}</span>"`;
                
                // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è (–ü–æ—Ö–æ–∂–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è)
                const filtered = allGamesCache.filter(g => 
                    g.name.toLowerCase().includes(query) || 
                    g.author.toLowerCase().includes(query)
                );
                
                renderGames(filtered, true);
            } else {
                // –°–±—Ä–æ—Å
                discoverTitle.style.display = 'block';
                searchStatus.innerHTML = '';
                renderGames(allGamesCache, false);
            }
        });

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–≥—Ä –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
        socket.on('update_dashboard', games => {
            allGamesCache = games; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫—ç—à
            // –ï—Å–ª–∏ –≤ –ø–æ–∏—Å–∫–µ —á—Ç–æ-—Ç–æ –µ—Å—Ç—å, –Ω–µ —Å–±–∏–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã, –∏–Ω–∞—á–µ —Ä–µ–Ω–¥–µ—Ä–∏–º –≤—Å—ë
            if(searchInput.value.trim() === "") {
                renderGames(games, false);
            }
            renderMyGames(games);
        });

        function renderGames(games, isSearch) {
            const list = document.getElementById('games-list');
            list.innerHTML = '';

            if(games.length === 0) {
                list.innerHTML = isSearch 
                    ? '<div style="grid-column:1/-1; text-align:center; color:#666; padding:20px;">No games found matching your query.</div>'
                    : '<div style="grid-column:1/-1; text-align:center; color:#666;">No popular games yet.</div>';
                return;
            }

            games.forEach(g => {
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <div class="card-img-placeholder">
                        <span style="font-size:30px;">üéÆ</span>
                    </div>
                    <div class="card-content">
                        <h4>${g.name}</h4>
                        <div class="card-meta">
                            <span>üü¢ ${g.online || 0} Playing</span>
                            <span>üëÅÔ∏è ${g.visits || 0}</span>
                        </div>
                    </div>
                `;
                card.onclick = () => openGameModal(g);
                list.appendChild(card);
            });
        }

        function renderMyGames(games) {
            const myList = document.getElementById('my-games-list');
            const myGames = games.filter(g => user && g.author === user.username);
            
            if(myGames.length === 0) {
                myList.innerHTML = '<p style="color: #666; padding:10px;">You haven\'t published any games yet.</p>';
                return;
            }

            myList.innerHTML = '';
            myGames.forEach(g => {
                const myCard = document.createElement('div');
                myCard.className = 'card';
                myCard.innerHTML = `
                    <div class="card-img-placeholder" style="background: linear-gradient(135deg, #2d3436, #000);">
                        <span style="font-size:30px;">üõ†Ô∏è</span>
                    </div>
                    <div class="card-content">
                        <h4>${g.name}</h4>
                        <div class="card-actions">
                            <button class="btn-card btn-play-card" onclick="event.stopPropagation(); location.href='game.html?id=${g.id}'">‚ñ∂ PLAY</button>
                            <button class="btn-card btn-edit-card" onclick="event.stopPropagation(); location.href='studio.html?id=${g.id}'">‚úé EDIT</button>
                        </div>
                    </div>
                `;
                myCard.onclick = () => location.href = `studio.html?id=${g.id}`;
                myList.appendChild(myCard);
            });
        }

        function openGameModal(game) {
            document.getElementById('gm-name').textContent = game.name;
            document.getElementById('gm-author').textContent = "By " + game.author;
            document.getElementById('gm-online').textContent = `Online: ${game.online || 0}`;
            document.getElementById('gm-visits').textContent = `Visits: ${game.visits || 0}`;
            document.getElementById('btn-play').onclick = () => location.href = `game.html?id=${game.id}`;
            
            const modal = document.getElementById('game-modal');
            modal.style.display = 'flex';
        }

        function closeGameModal() { 
            document.getElementById('game-modal').style.display = 'none'; 
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –æ–∫–Ω–∞
        window.onclick = function(event) {
            const modal = document.getElementById('game-modal');
            if (event.target == modal) {
                closeGameModal();
            }
        }
        
        init();
    </script>
</body>
</html>